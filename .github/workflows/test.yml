name: Quick Build Test

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_NAME: Codesphere
  BINARY_NAME: codesphere
  VSCODE_QUALITY: stable

jobs:
  compliance-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
    
    - name: Install ripgrep
      run: sudo apt-get update && sudo apt-get install -y ripgrep
    
    - name: Apply Codesphere branding
      run: |
        chmod +x ci/*.sh
        ./ci/ci-branding.sh
    
    - name: Prepare VSCode source
      working-directory: vendor/vscodium
      run: |
        export SHOULD_BUILD=yes
        export CI_BUILD=yes
        export OS_NAME=linux
        ./get_repo.sh
        ./prepare_vscode.sh
    
    - name: Run compliance check
      run: ./ci/compliance-check.sh
      continue-on-error: false

  test-build-linux-x64:
    runs-on: ubuntu-latest
    needs: compliance-check
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc g++ make pkg-config libx11-dev libxkbfile-dev libsecret-1-dev libkrb5-dev jq
    
    - name: Apply Codesphere branding
      run: |
        chmod +x ci/*.sh
        ./ci/ci-branding.sh
    
    - name: Prepare VSCode source
      working-directory: vendor/vscodium
      run: |
        export SHOULD_BUILD=yes
        export CI_BUILD=yes
        export OS_NAME=linux
        ./get_repo.sh
        ./prepare_vscode.sh
    
    - name: Test compile
      working-directory: vendor/vscodium/vscode
      run: |
        yarn install --frozen-lockfile
        yarn compile
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Verify branding
      run: |
        echo "âœ… Compilation successful"
        echo "Checking product.json..."
        cat vendor/vscodium/vscode/product.json | jq '.nameShort, .applicationName, .extensionsGallery.serviceUrl'
